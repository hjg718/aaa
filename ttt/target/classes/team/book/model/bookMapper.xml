<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="team.book.model.BookDao">

	<select id="search" resultMap="book">
		SELECT * FROM
		(
			SELECT bnum,bname,bindex,author,publisher,bcontents,pdate,covername,
			CEIL(rn/6) page, CEIL((count(*)OVER())/6) tpg FROM
			(
				SELECT bnum,bname,bindex,author,publisher,bcontents,pdate,covername,ROWNUM rn 
				FROM Book WHERE	${category} LIKE '%'||#{keyword}||'%' ORDER BY bnum
			)
		)
		WHERE page=#{page}
	</select>
	
	<resultMap type="team.book.model.Book" id="book">
		<result property="page" column="page"/>
		<result property="tpg" column="tpg"/>
		
		<collection property="list" column="bnum" javaType="ArrayList" 
		ofType="team.book.model.BookVo">
			<id property="bnum" column="bnum" />
			<result property="bname" column="bname" />
			<result property="bcontents" column="bcontents" />
			<result property="bindex" column="bindex" />
			<result property="author" column="author" />
			<result property="publisher" column="publisher" />
			<result property="pdate" column="pdate" />
			<result property="coverName" column="covername" />
		</collection>
	</resultMap>
	
	<insert id="add" parameterType="team.book.model.BookVo">
		INSERT INTO book
		values(SEQ_BOOK.NEXTVAL,#{bname},#{bindex},#{author},#{publisher},#{bcontents},#{pdate},SEQ_BOOK.CURRVAL||'.'||#{coverName})
		<selectKey order="AFTER" resultType="int" keyProperty="bnum">
			SELECT SEQ_BOOK.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	<insert id="addcate">
		INSERT INTO category values(#{num},#{cate})
	</insert>
	<select id="read" resultType="team.book.model.BookVo">
		SELECT * FROM book WHERE bnum=#{num}
	</select>
	<select id="getcate" resultType="String">
		SELECT cate FROM category WHERE bnum=#{num}
	</select>
</mapper>
